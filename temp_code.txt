# Nueva funci贸n para b煤squeda exacta por c贸digo
def buscar_codigo_exacto_en_proveedor(codigo, proveedor, solo_ricky=False, solo_fg=False):
    """Busca un c贸digo espec铆fico en un proveedor espec铆fico con criterios muy estrictos"""
    resultados = []
    
    try:
        if not codigo.isdigit() or not proveedor:
            return []
        
        # Verificar que exista la configuraci贸n del proveedor
        if proveedor not in PROVEEDOR_CONFIG:
            print(f"[EXCEL] Error: Proveedor '{proveedor}' no configurado")
            return []
            
        # Obtener configuraci贸n del proveedor
        config = PROVEEDOR_CONFIG[proveedor]
        dueno = config.get('dueno', 'ferreteria_general')
        
        # Verificar si el proveedor est谩 habilitado para el filtro de due帽o
        if (solo_ricky and dueno != 'ricky') or (solo_fg and dueno != 'ferreteria_general'):
            return []
            
        # Usar buscar_en_excel_proveedor pero solo para ese proveedor
        todos_resultados = buscar_en_excel_proveedor(codigo, proveedor)
        
        # Filtrar SOLO los que coinciden exactamente con el c贸digo buscado
        resultados = []
        for r in todos_resultados:
            r_codigo = str(r.get('codigo', '')).strip()
            if r_codigo == codigo:
                resultados.append(r)
                
        print(f"[EXCEL] B煤squeda exacta de c贸digo '{codigo}' en proveedor '{proveedor}': {len(resultados)} resultados")
        return resultados
        
    except Exception as e:
        print(f"[EXCEL] Error en buscar_codigo_exacto_en_proveedor: {e}")
        return []

# C贸digo para reemplazar en la ruta /agregar_producto
# Realizar b煤squeda en Excel si hay t茅rmino
if termino_excel:
    print(f" Buscando: '{termino_excel}' con filtro proveedor: '{proveedor_excel_filtro}' | solo_ricky: {solo_ricky} | solo_fg: {solo_fg}")
    
    # Si el t茅rmino es un c贸digo num茅rico y tenemos proveedor espec铆fico, usar b煤squeda precisa
    if termino_excel.isdigit() and proveedor_excel_filtro:
        print(f" Realizando b煤squeda espec铆fica de c贸digo exacto: {termino_excel} en {proveedor_excel_filtro}")
        # Buscar el c贸digo exacto en el proveedor espec铆fico
        resultados_exactos = buscar_codigo_exacto_en_proveedor(
            termino_excel, 
            proveedor_excel_filtro, 
            solo_ricky=solo_ricky, 
            solo_fg=solo_fg
        )
        
        if resultados_exactos:
            print(f" Encontrados {len(resultados_exactos)} resultados exactos")
            resultados_excel = resultados_exactos
        else:
            # Hacer la b煤squeda normal y luego filtrar estrictamente
            print(f" No hay coincidencias exactas, buscando alternativas...")
            resultados_excel = buscar_en_excel(termino_excel, proveedor_excel_filtro, filtro_excel, solo_ricky=solo_ricky, solo_fg=solo_fg)
            
            # Aplicar filtro extremadamente estricto - solo el c贸digo exacto
            resultados_filtrados = [
                r for r in resultados_excel 
                if str(r.get('codigo', '')).strip() == termino_excel 
                and str(r.get('proveedor', '')).lower().strip() == proveedor_excel_filtro.lower()
            ]
            
            if resultados_filtrados:
                resultados_excel = resultados_filtrados
                print(f" Filtrado a {len(resultados_excel)} coincidencias exactas de c贸digo")
    else:
        # B煤squeda normal para t茅rminos de texto o sin proveedor espec铆fico
        resultados_excel = buscar_en_excel(termino_excel, proveedor_excel_filtro, filtro_excel, solo_ricky=solo_ricky, solo_fg=solo_fg)
        print(f" Resultados encontrados: {len(resultados_excel)}")
        
        # Filtrar resultados para eliminar entradas inv谩lidas
        resultados_excel = [r for r in resultados_excel if r.get('nombre') and not r.get('nombre').startswith('Fila ')]
        
        # Si hay un proveedor seleccionado, aplicar filtro
        if proveedor_excel_filtro:
            resultados_excel = [r for r in resultados_excel if r.get('proveedor', '').lower() == proveedor_excel_filtro.lower()]
            print(f" Resultados filtrados por proveedor: {len(resultados_excel)}")
