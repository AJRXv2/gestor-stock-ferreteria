<!-- templates/seccion_gestion_productos.html -->
<div class="card section-card">
    <div class="card-header"><h2>Gestión de Productos</h2></div>
    <div class="card-body">
        <!-- Buscador principal -->
        <form method="get" action="{{ url_for('index') }}">
            <div class="row g-2 mb-3">
                <div class="col-md-4">
                    <select name="proveedor" class="form-select">
                        <option value="">Todos los proveedores</option>
                        {% for proveedor in proveedores %}
                            <option value="{{ proveedor.nombre }}">{{ proveedor.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <input type="text" name="q_excel" class="form-control" placeholder="Buscar por nombre, código o Excel" value="{{ termino_busqueda_excel }}">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-info w-100" type="submit">Buscar</button>
                </div>
            </div>
        </form>
        <!-- Filtro secundario -->
        {% if resultados_excel %}
        <form method="get" action="{{ url_for('index') }}" class="mb-3">
            <input type="hidden" name="q_excel" value="{{ termino_busqueda_excel }}">
            <div class="input-group">
                <input type="text" name="filtro_excel" class="form-control" placeholder="Filtrar por medida, tipo, etc." value="{{ filtro_excel }}">
                <button class="btn btn-secondary" type="submit">Filtrar</button>
            </div>
        </form>
        {% endif %}
        <!-- Resultados de búsqueda -->
        {% if resultados_excel %}
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Código</th>
                    <th>Nombre</th>
                    <th>Proveedor</th>
                    <th>Precio</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody>
                {% for r in resultados_excel %}
                <tr>
                    <td>{{ r.codigo }}</td>
                    <td>{{ r.nombre }}</td>
                    <td>{{ r.proveedor or 'N/A' }}</td>
                    <td>${{ "%.2f"|format(r.precio) }}</td>
                    <td>
                        <form method="post" action="{{ url_for('agregar') }}">
                            <input type="hidden" name="codigo" value="{{ r.codigo }}">
                            <input type="hidden" name="nombre" value="{{ r.nombre }}">
                            <input type="hidden" name="precio" value="{{ r.precio }}">
                            <input type="hidden" name="proveedor" value="{{ r.proveedor }}">
                            <input type="number" name="cantidad" class="form-control form-control-sm mb-1" placeholder="Cantidad" min="1" required>
                            <input type="date" name="fecha_compra" class="form-control form-control-sm mb-1" value="{{ fecha_actual }}" required>
                            <button class="btn btn-success btn-sm w-100" type="submit">Añadir al Stock</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
        <!-- Productos añadidos -->
        <h5 class="mt-4">Productos en Stock</h5>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Código</th>
                    <th>Nombre</th>
                    <th>Proveedor</th>
                    <th>Precio</th>
                    <th>Cantidad</th>
                    <th>Fecha</th>
                </tr>
            </thead>
            <tbody>
                {% for p in productos %}
                <tr>
                    <td>{{ p.codigo }}</td>
                    <td>{{ p.nombre }}</td>
                    <td>{{ p.proveedor or 'N/A' }}</td>
                    <td>${{ "%.2f"|format(p.precio) }}</td>
                    <td>{{ p.cantidad }}</td>
                    <td>{{ p.fecha_compra }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>