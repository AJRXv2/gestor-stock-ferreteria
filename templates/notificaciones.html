{% extends "base.html" %}

{% block title %}Notificaciones de Stock{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>
        <i class="bi bi-bell me-2 position-relative">
            {% set hay_no_leidas = notificaciones | selectattr('leida','equalto',0) | list | length %}
            {% if hay_no_leidas > 0 %}
            <span style="position:absolute;top:0;right:-8px;width:12px;height:12px;background:red;border-radius:50%;display:inline-block;"></span>
            {% endif %}
        </i>
        Notificaciones de Stock
    </h2>
    <div class="d-flex gap-2">
        {% if notificaciones and notificaciones|length > 0 %}
        <form method="post" action="{{ url_for('marcar_notificaciones_leidas') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-outline-primary">Marcar como leídas</button>
        </form>
        <form method="post" action="{{ url_for('borrar_todas_notificaciones') }}" onsubmit="return confirm('¿Borrar todas las notificaciones?');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-danger">Borrar todas</button>
        </form>
        {% endif %}
    </div>
</div>
{% if notificaciones and notificaciones|length > 0 %}
<ul class="list-group mb-4">
    {% for n in notificaciones %}
    <li class="list-group-item {% if n.leida == 0 %}fw-semibold{% endif %}">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <div class="mb-1"><strong>{{ n.mensaje }}</strong>{% if n.leida == 0 %} <span class="badge bg-warning text-dark ms-2">Nueva</span>{% endif %}</div>
                <div class="text-muted small">
                    {% if n.codigo %}<span><strong>Código:</strong> {{ n.codigo }}</span>{% endif %}
                    {% if n.proveedor %}<span class="ms-3"><strong>Proveedor:</strong> {{ n.proveedor }}</span>{% endif %}
                    {% if n.ts %}<span class="ms-3"><strong>Fecha:</strong> {{ n.ts }}</span>{% endif %}
                </div>
            </div>
            {# n es un dict devuelto por db_query, siempre debe tener clave 'id' #}
            <form method="post" action="{{ url_for('borrar_notificacion', idx=n['id']) }}" onsubmit="return confirm('¿Borrar esta notificación?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-outline-secondary btn-sm">Borrar</button>
            </form>
        </div>
    </li>
    {% endfor %}
</ul>
{% else %}
<p class="text-muted">No hay notificaciones.</p>
{% endif %}
{% endblock %}