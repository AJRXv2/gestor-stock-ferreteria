{% extends "base.html" %}

{% block title %}Gestionar Proveedores{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Gestionar Proveedores</h1>
</div>

<div class="row">
    <!-- Columna para agregar proveedor Ferretería General -->
    <div class="col-md-3">
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-shop"></i> Ferretería General
                </h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('agregar_proveedor') }}" method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="input-group">
                        <input type="text" name="nombre" class="form-control" placeholder="Nombre del proveedor" required>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Agregar
                        </button>
                    </div>
                    <small class="text-muted mt-2 d-block">Se agregará a Ferretería General</small>
                </form>
                {% if proveedores_fg %}
                <hr>
                <div class="small text-muted">Proveedores actuales:</div>
                <ul class="list-group list-group-flush">
                    {% for p in proveedores_fg %}
                    <li class="list-group-item py-1">{{ p.nombre }}</li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Columna para agregar proveedor Ricky -->
    <div class="col-md-3">
        <div class="card mb-3">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="bi bi-person-circle"></i> Ricky
                </h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('agregar_proveedor') }}" method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="dueno" value="ricky">
                    <div class="input-group">
                        <input type="text" name="nombre" class="form-control" placeholder="Nombre del proveedor" required>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-plus-circle"></i> Agregar
                        </button>
                    </div>
                    <small class="text-muted mt-2 d-block">Se agregará a los proveedores de Ricky</small>
                </form>
                {% if proveedores_ricky %}
                <hr>
                <div class="small text-muted">Proveedores actuales:</div>
                <ul class="list-group list-group-flush">
                    {% for p in proveedores_ricky %}
                    <li class="list-group-item py-1">{{ p.nombre }}</li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Columna para buscar y eliminar proveedores -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h4>
                    <i class="bi bi-search"></i> Buscar y Eliminar Proveedores
                </h4>
            </div>
            <div class="card-body">
                <form method="get" action="{{ url_for('proveedores') }}" class="mb-3">
                    <div class="input-group">
                        <input type="text" name="busqueda_proveedor" class="form-control" 
                               placeholder="Buscar en todos los proveedores..." 
                               value="{{ busqueda_proveedor or '' }}">
                        <button class="btn btn-outline-primary" type="submit">
                            <i class="bi bi-search"></i> Buscar
                        </button>
                        <button class="btn btn-outline-secondary" type="button" id="btnVerOcultos">
                            <i class="bi bi-eye-slash"></i> Ver ocultos
                        </button>
                    </div>
                </form>
                
                {% if proveedores_encontrados and busqueda_proveedor %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Se encontraron {{ proveedores_encontrados|length }} proveedor(es) que coinciden con "{{ busqueda_proveedor }}"
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Proveedor</th>
                                <th>Dueño</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for proveedor in proveedores_encontrados %}
                            <tr>
                                <td>
                                    <strong>{{ proveedor.nombre }}</strong>
                                </td>
                                <td>
                                    {% if proveedor.dueno == 'ricky' %}
                                        Ricky
                                    {% else %}
                                        Ferretería General
                                    {% endif %}
                                </td>
                                <td>
                                    <form method="post" action="{{ url_for('eliminar_proveedor_manual') }}" style="display:inline-block">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <input type="hidden" name="id" value="{{ proveedor.id }}">
                                        <input type="hidden" name="dueno" value="{{ proveedor.dueno }}">
                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Ocultar proveedor {{ proveedor.nombre|escape }}?');">
                                            <i class="bi bi-trash"></i> Eliminar
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% elif busqueda_proveedor %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> No se encontraron proveedores que coincidan con "{{ busqueda_proveedor }}"
                </div>
                {% else %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Proveedor</th>
                                <th>Dueño</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for proveedor in todos_proveedores %}
                            <tr>
                                <td><strong>{{ proveedor.nombre }}</strong></td>
                                <td>
                                    {% if proveedor.dueno == 'ricky' %}
                                        Ricky
                                    {% else %}
                                        Ferretería General
                                    {% endif %}
                                </td>
                                <td>
                                    <form method="post" action="{{ url_for('eliminar_proveedor_manual') }}" style="display:inline-block">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <input type="hidden" name="id" value="{{ proveedor.id }}">
                                        <input type="hidden" name="dueno" value="{{ proveedor.dueno }}">
                                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Ocultar proveedor {{ proveedor.nombre|escape }}?');">
                                            <i class="bi bi-trash"></i> Eliminar
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal Proveedores Ocultos -->
<div class="modal fade" id="modalOcultos" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-eye-slash"></i> Proveedores Ocultos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex gap-2 mb-3 align-items-center">
            <select id="filtroDuenoOculto" class="form-select" style="max-width:220px">
                <option value="todos">Todos los dueños</option>
                <option value="ricky">Ricky</option>
                <option value="ferreteria_general">Ferretería General</option>
            </select>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="chkIncluirVisibles">
              <label class="form-check-label small" for="chkIncluirVisibles">Incluir visibles</label>
            </div>
            <button class="btn btn-sm btn-outline-primary" id="btnRefrescarOcultos">
                <i class="bi bi-arrow-clockwise"></i> Refrescar
            </button>
        </div>
        <div id="contenedorOcultos">
            <div class="text-muted">Cargando...</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const btnVerOcultos = document.getElementById('btnVerOcultos');
    const modalEl = document.getElementById('modalOcultos');
    const filtroDueno = document.getElementById('filtroDuenoOculto');
    const btnRefrescar = document.getElementById('btnRefrescarOcultos');
    const contenedor = document.getElementById('contenedorOcultos');

    let bsModal;
    if (modalEl) {
        bsModal = new bootstrap.Modal(modalEl);
    }

    function cargarOcultos() {
        const d = filtroDueno.value;
        const inc = document.getElementById('chkIncluirVisibles').checked ? '1' : '0';
        contenedor.innerHTML = '<div class="text-muted">Cargando...</div>';
        fetch(`/proveedores_ocultos?dueno=${encodeURIComponent(d)}&include_visible=${inc}`)
          .then(r => r.json())
          .then(data => {
              if (!data.success) {
                  contenedor.innerHTML = '<div class="alert alert-danger">Error al cargar.</div>';
                  return;
              }
              if (!data.proveedores.length) {
                  contenedor.innerHTML = '<div class="alert alert-info">No hay proveedores ocultos para el filtro seleccionado.</div>';
                  return;
              }
          let html = '<div class="table-responsive"><table class="table table-sm table-striped">'+
             '<thead><tr><th>Nombre</th><th>Dueño</th><th style="width:210px">Acciones</th></tr></thead><tbody>';
              const inc = document.getElementById('chkIncluirVisibles').checked;
              for (const p of data.proveedores) {
                  if (inc && data.matrix) {
                      // Formato matriz: una fila por nombre con columnas de estado
                      let estadoR = '';
                      if (p.oculto_ricky && !p.visible_ricky) estadoR = '<span class="badge bg-secondary">Oculto</span>';
                      else if (p.oculto_ricky && p.visible_ricky) estadoR = '<span class="badge bg-warning text-dark">Oculto + Visible</span>';
                      else if (p.visible_ricky) estadoR = '<span class="badge bg-success">Visible</span>';
                      else estadoR = '<span class="badge bg-light text-dark">N/A</span>';
                      let estadoF = '';
                      if (p.oculto_ferreteria_general && !p.visible_ferreteria_general) estadoF = '<span class="badge bg-secondary">Oculto</span>';
                      else if (p.oculto_ferreteria_general && p.visible_ferreteria_general) estadoF = '<span class="badge bg-warning text-dark">Oculto + Visible</span>';
                      else if (p.visible_ferreteria_general) estadoF = '<span class="badge bg-success">Visible</span>';
                      else estadoF = '<span class="badge bg-light text-dark">N/A</span>';
                      html += `<tr>`+
                              `<td><strong>${p.nombre}</strong></td>`+
                              `<td>${estadoR}</td>`+
                              `<td>${estadoF}</td>`+
                              `<td class="d-flex flex-wrap gap-1">`+
                              (p.oculto_ricky ? `<button class=\"btn btn-sm btn-outline-primary\" data-action=\"restaurar\" data-nombre=\"${p.nombre}\" data-dueno=\"ricky\">Ricky +</button>` : '')+
                              (p.oculto_ferreteria_general ? `<button class=\"btn btn-sm btn-outline-primary\" data-action=\"restaurar\" data-nombre=\"${p.nombre}\" data-dueno=\"ferreteria_general\">FG +</button>` : '')+
                              (p.oculto_ricky ? `<button class=\"btn btn-sm btn-outline-danger\" data-action=\"eliminar\" data-nombre=\"${p.nombre}\" data-dueno=\"ricky\">Del R</button>` : '')+
                              (p.oculto_ferreteria_general ? `<button class=\"btn btn-sm btn-outline-danger\" data-action=\"eliminar\" data-nombre=\"${p.nombre}\" data-dueno=\"ferreteria_general\">Del FG</button>` : '')+
                              `</td>`+
                              `</tr>`;
                  } else {
                      // Modo lista (compat)
                      const duenoLabel = p.dueno === 'ricky' ? 'Ricky' : 'Ferretería General';
                      html += `<tr>`+
                              `<td><strong>${p.nombre}</strong></td>`+
                              `<td>${duenoLabel}</td>`+
                              `<td class=\"d-flex gap-1\">`+
                              `<button class=\"btn btn-sm btn-success\" data-action=\"restaurar\" data-nombre=\"${p.nombre}\" data-dueno=\"${p.dueno}\"><i class=\"bi bi-arrow-counterclockwise\"></i> Restaurar</button>`+
                              `<button class=\"btn btn-sm btn-outline-danger\" data-action=\"eliminar\" data-nombre=\"${p.nombre}\" data-dueno=\"${p.dueno}\"><i class=\"bi bi-x-circle\"></i> Eliminar</button>`+
                              `</td>`+
                              `</tr>`;
                  }
              }
              html += '</tbody></table></div>';
              contenedor.innerHTML = html;
          })
          .catch(err => {
              console.error('Error fetch ocultos', err);
              contenedor.innerHTML = '<div class="alert alert-danger">Error de red.</div>';
          });
    }

    btnVerOcultos?.addEventListener('click', () => {
        bsModal?.show();
        cargarOcultos();
    });
    filtroDueno?.addEventListener('change', cargarOcultos);
    document.getElementById('chkIncluirVisibles')?.addEventListener('change', cargarOcultos);
    btnRefrescar?.addEventListener('click', cargarOcultos);

    contenedor?.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-nombre]');
        if (!btn) return;
        const nombre = btn.getAttribute('data-nombre');
        const dueno = btn.getAttribute('data-dueno');
        const action = btn.getAttribute('data-action');
        // Obtener token CSRF desde primer formulario presente
        const csrfInput = document.querySelector('input[name="csrf_token"]');
        const csrfToken = csrfInput ? csrfInput.value : '';
        if (action === 'restaurar') {
            if (!confirm(`Restaurar proveedor "${nombre}" para ${dueno === 'ricky' ? 'Ricky' : 'Ferretería General'}?`)) return;
            fetch('/restaurar_proveedor_oculto', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ nombre, dueno })
            }).then(r => r.json())
              .then(data => {
                  if (data.success) {
                      cargarOcultos();
                      setTimeout(() => { window.location.reload(); }, 500);
                  } else {
                      alert(data.error || 'Error al restaurar');
                  }
              })
              .catch(err => {
                  console.error('Error restaurando', err);
                  alert('Error de red al restaurar');
              });
        } else if (action === 'eliminar') {
            if (!confirm(`Eliminar DEFINITIVAMENTE el proveedor "${nombre}" para ${dueno === 'ricky' ? 'Ricky' : 'Ferretería General'}?\n\nEsta acción no se puede deshacer.`)) return;
            fetch('/eliminar_proveedor_definitivo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ nombre, dueno })
            }).then(r => r.json())
              .then(data => {
                  if (data.success) {
                      cargarOcultos();
                      setTimeout(() => { window.location.reload(); }, 700);
                  } else {
                      alert(data.error || 'Error al eliminar');
                  }
              })
              .catch(err => {
                  console.error('Error eliminando', err);
                  alert('Error de red al eliminar');
              });
        }
    });
});
</script>
{% endblock %}
