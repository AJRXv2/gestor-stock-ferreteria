{% extends 'base.html' %}

{% block title %}Escaneo de Productos{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2><i class="bi bi-upc-scan me-2"></i>Escaneo de Productos</h2>
    
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-barcode me-2"></i>Escanear Código de Barras</h5>
                </div>
                <div class="card-body">
                    <form id="escanerForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <div class="mb-3">
                            <label for="codigo_barras" class="form-label">Código de Barras:</label>
                            <input type="text" class="form-control form-control-lg" id="codigo_barras" name="codigo_barras" autofocus 
                                placeholder="Escanee un código o ingrese manualmente...">
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-lg">
                            <span id="btnTexto">Buscar Producto</span>
                            <span id="btnSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        </button>
                        <button type="button" class="btn btn-secondary btn-lg ms-2" onclick="limpiarFormulario()">Limpiar</button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Instrucciones</h5>
                </div>
                <div class="card-body">
                    <ol>
                        <li>Asegúrese de que el cursor esté en el campo de código.</li>
                        <li>Escanee el código de barras del producto.</li>
                        <li>Los resultados aparecerán automáticamente abajo.</li>
                        <li>Use los botones para vender directamente o agregar a la mesa.</li>
                    </ol>
                    <div class="alert alert-info">
                        <i class="bi bi-lightbulb me-2"></i>El escáner se mantiene activo para escanear múltiples productos sin recargar la página.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sección de Resultados Dinámicos -->
    <div class="row mt-4" id="seccionResultados" style="display:none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-search me-2"></i>Productos Encontrados</h5>
                </div>
                <div class="card-body">
                    <div id="productosEncontrados">
                        <!-- Contenido dinámico de productos -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Mesa de Ventas (igual que en confirmar_escaneo.html) -->
    <div class="row mt-4" id="mesaVentas" style="display:none;">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-table me-2"></i>Mesa de Ventas 
                            <span class="badge bg-light text-dark" id="contadorMesa">0</span>
                        </h5>
                        <div>
                            <button type="button" class="btn btn-success me-2" id="btnVenderMesa" onclick="procesarVentaMesa()" disabled>
                                <i class="bi bi-cart-check"></i> Vender Todo
                            </button>
                            <button type="button" class="btn btn-warning me-2" onclick="limpiarMesa()">
                                <i class="bi bi-trash"></i> Limpiar
                            </button>
                            <button type="button" class="btn btn-outline-light" onclick="ocultarMesa()">
                                <i class="bi bi-eye-slash"></i> Ocultar
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Proveedor</th>
                                    <th>Precio Unit.</th>
                                    <th>Cantidad</th>
                                    <th>Subtotal</th>
                                    <th>Stock</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="cuerpoMesa">
                                <!-- Contenido dinámico -->
                            </tbody>
                            <tfoot>
                                <tr class="table-primary">
                                    <td colspan="4"><strong>TOTAL:</strong></td>
                                    <td><strong id="totalMesa">$0.00</strong></td>
                                    <td colspan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let mesaVentas = [];
let contadorId = 0;

// Funciones de persistencia del carrito
function guardarCarrito() {
    localStorage.setItem('mesaVentas', JSON.stringify(mesaVentas));
    localStorage.setItem('contadorId', contadorId.toString());
}

function cargarCarrito() {
    const carritoGuardado = localStorage.getItem('mesaVentas');
    const contadorGuardado = localStorage.getItem('contadorId');
    
    if (carritoGuardado) {
        mesaVentas = JSON.parse(carritoGuardado);
    }
    
    if (contadorGuardado) {
        contadorId = parseInt(contadorGuardado);
    }
    
    // Actualizar la tabla visual
    actualizarMesa();
}

document.addEventListener('DOMContentLoaded', function() {
    // Cargar carrito guardado al iniciar
    cargarCarrito();
    
    // Auto-enfoque en el campo de código de barras
    document.getElementById('codigo_barras').focus();
    
    // Manejar envío del formulario con AJAX
    document.getElementById('escanerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        procesarEscaneo();
    });
    
    // Manejar la entrada del escáner
    const inputCodigo = document.getElementById('codigo_barras');
    
    // Muchos escáneres terminan con enter, así que podemos autoenviar el formulario
    inputCodigo.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            procesarEscaneo();
        }
    });
    
    // Para escáneres que no envían enter, podemos detectar cuando se detiene la entrada rápida
    let typingTimer;
    const doneTypingInterval = 500; // Tiempo en ms después del cual consideramos que terminó el escaneo
    
    inputCodigo.addEventListener('keyup', function() {
        clearTimeout(typingTimer);
        if (inputCodigo.value) {
            typingTimer = setTimeout(function() {
                // Si el código tiene longitud suficiente para ser un código de barras, asumimos que el escaneo terminó
                if (inputCodigo.value.length >= 8 && inputCodigo.value.length <= 20) {
                    procesarEscaneo();
                }
            }, doneTypingInterval);
        }
    });
});

function procesarEscaneo() {
    const codigoBarras = document.getElementById('codigo_barras').value.trim();
    
    if (!codigoBarras) {
        alert('Debe ingresar un código de barras');
        return;
    }
    
    // Mostrar spinner
    document.getElementById('btnTexto').textContent = 'Buscando...';
    document.getElementById('btnSpinner').classList.remove('d-none');
    
    // Enviar petición AJAX
    fetch('{{ url_for("procesar_escaneo") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: new URLSearchParams({
            'codigo_barras': codigoBarras,
            'csrf_token': '{{ csrf_token() }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        // Ocultar spinner
        document.getElementById('btnTexto').textContent = 'Buscar Producto';
        document.getElementById('btnSpinner').classList.add('d-none');
        
        if (data.success) {
            mostrarProductos(data.productos);
            // Limpiar campo para próximo escaneo
            document.getElementById('codigo_barras').value = '';
            document.getElementById('codigo_barras').focus();
        } else {
            mostrarError(data.message);
            // No limpiar campo en caso de error para permitir corrección
            document.getElementById('codigo_barras').select();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Ocultar spinner
        document.getElementById('btnTexto').textContent = 'Buscar Producto';
        document.getElementById('btnSpinner').classList.add('d-none');
        alert('Error al procesar el escaneo: ' + error.message);
        document.getElementById('codigo_barras').select();
    });
}

function mostrarProductos(productos) {
    const seccionResultados = document.getElementById('seccionResultados');
    const productosEncontrados = document.getElementById('productosEncontrados');
    
    let html = `<div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Código</th>
                    <th>Producto</th>
                    <th>Proveedor</th>
                    <th>Stock</th>
                    <th>Precio</th>
                    <th>Dueño</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>`;
    
    productos.forEach(producto => {
        html += `<tr>
            <td>
                <span class="badge bg-primary">${producto.codigo_extraido}</span>
                <br>
                <small class="text-muted">Original: ${producto.codigo}</small>
            </td>
            <td><strong>${producto.nombre}</strong></td>
            <td><span class="badge bg-secondary">${producto.proveedor || 'N/A'}</span></td>
            <td>`;
        
        if (producto.source === 'excel') {
            html += `<div>
                <span class="badge bg-info">Solo en Lista de Precios</span>
                <br>
                <small class="text-muted">No hay stock físico</small>
            </div>`;
        } else if (producto.cantidad <= 0) {
            html += `<span class="badge bg-danger">Sin stock</span>`;
        } else if (producto.cantidad <= 5) {
            html += `<span class="badge bg-warning">${producto.cantidad} unidades</span>`;
        } else {
            html += `<span class="badge bg-success">${producto.cantidad} unidades</span>`;
        }
        
        html += `</td>
            <td><strong>$${parseFloat(producto.precio).toFixed(2)}</strong></td>
            <td><span class="badge ${producto.dueno === 'ricky' ? 'bg-info' : 'bg-warning'}">${producto.dueno || 'N/A'}</span></td>
            <td>`;
        
        if (producto.source === 'excel') {
            // Producto solo en lista de precios
            html += `<button type="button" class="btn btn-warning btn-sm" 
                data-producto-id="${producto.id}" 
                data-codigo="${producto.codigo}" 
                data-nombre="${producto.nombre}" 
                data-precio="${producto.precio}" 
                data-proveedor="${producto.proveedor}" 
                data-stock="0" 
                data-sin-stock="true"
                onclick="agregarAMesaFromButton(this)"
                title="Este producto no está en stock, solo en lista de precios">
                <i class="bi bi-table"></i> A Mesa (Sin Stock)
            </button>`;
        } else if (producto.cantidad > 0) {
            html += `<div class="btn-group-vertical" role="group">
                <form method="post" action="{{ url_for('ejecutar_venta_escaneo') }}" class="mb-1" style="display:inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="producto_id" value="${producto.id}">
                    <div class="input-group input-group-sm">
                        <input type="number" class="form-control" name="cantidad" value="1" min="1" max="${producto.cantidad}" style="width: 60px;">
                        <button type="submit" class="btn btn-success btn-sm">
                            <i class="bi bi-cart-plus"></i> Vender
                        </button>
                    </div>
                </form>
                <button type="button" class="btn btn-primary btn-sm" 
                    data-producto-id="${producto.id}" 
                    data-codigo="${producto.codigo}" 
                    data-nombre="${producto.nombre}" 
                    data-precio="${producto.precio}" 
                    data-proveedor="${producto.proveedor}" 
                    data-stock="${producto.cantidad}" 
                    data-sin-stock="false"
                    onclick="agregarAMesaFromButton(this)">
                    <i class="bi bi-table"></i> A Mesa
                </button>
            </div>`;
        } else {
            html += `<span class="text-muted">Sin acciones disponibles</span>`;
        }
        
        html += `</td></tr>`;
    });
    
    html += `</tbody></table></div>`;
    
    productosEncontrados.innerHTML = html;
    seccionResultados.style.display = 'block';
    
    // Scroll suave hacia los resultados
    seccionResultados.scrollIntoView({ behavior: 'smooth' });
}

function mostrarError(mensaje) {
    const seccionResultados = document.getElementById('seccionResultados');
    const productosEncontrados = document.getElementById('productosEncontrados');
    
    productosEncontrados.innerHTML = `
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>No se encontraron productos</strong>
            <p class="mb-0">${mensaje}</p>
        </div>
    `;
    
    seccionResultados.style.display = 'block';
    seccionResultados.scrollIntoView({ behavior: 'smooth' });
}

function limpiarFormulario() {
    document.getElementById('codigo_barras').value = '';
    document.getElementById('seccionResultados').style.display = 'none';
    document.getElementById('codigo_barras').focus();
}

// Funciones de Mesa de Ventas (igual que en confirmar_escaneo.html)
function agregarAMesa(productoId, codigo, nombre, precio, proveedor, stockDisponible, sinStock = false) {
    // Nota: Eliminada la advertencia de stock físico por solicitud del usuario
    
    // Verificar si el producto ya existe en la mesa
    const existeIndex = mesaVentas.findIndex(item => item.productoId === productoId);
    
    if (existeIndex >= 0) {
        // Si existe, aumentar cantidad
        if (!sinStock && mesaVentas[existeIndex].cantidad < stockDisponible) {
            mesaVentas[existeIndex].cantidad++;
            mesaVentas[existeIndex].subtotal = mesaVentas[existeIndex].cantidad * mesaVentas[existeIndex].precio;
        } else if (sinStock) {
            // Para productos sin stock, permitir incrementar cantidad pero con advertencia
            mesaVentas[existeIndex].cantidad++;
            mesaVentas[existeIndex].subtotal = mesaVentas[existeIndex].cantidad * mesaVentas[existeIndex].precio;
        } else {
            alert('No hay más stock disponible para este producto');
            return;
        }
    } else {
        // Si no existe, agregar nuevo
        mesaVentas.push({
            id: ++contadorId,
            productoId: productoId,
            codigo: codigo,
            nombre: nombre,
            precio: precio,
            proveedor: proveedor,
            cantidad: 1,
            subtotal: precio,
            stockDisponible: stockDisponible,
            sinStock: sinStock
        });
    }
    
    actualizarMesa();
    guardarCarrito();
}

function agregarAMesaFromButton(button) {
    // Leer datos del botón usando data attributes
    const productoId = button.getAttribute('data-producto-id');
    const codigo = button.getAttribute('data-codigo');
    const nombre = button.getAttribute('data-nombre');
    const precio = parseFloat(button.getAttribute('data-precio'));
    const proveedor = button.getAttribute('data-proveedor');
    const stockDisponible = parseInt(button.getAttribute('data-stock'));
    const sinStock = button.getAttribute('data-sin-stock') === 'true';
    
    // Llamar a la función original
    agregarAMesa(productoId, codigo, nombre, precio, proveedor, stockDisponible, sinStock);
}

function actualizarMesa() {
    const cuerpoMesa = document.getElementById('cuerpoMesa');
    const contadorMesa = document.getElementById('contadorMesa');
    const totalMesa = document.getElementById('totalMesa');
    const btnVenderMesa = document.getElementById('btnVenderMesa');
    const mesaDiv = document.getElementById('mesaVentas');
    
    // Limpiar tabla
    cuerpoMesa.innerHTML = '';
    
    if (mesaVentas.length === 0) {
        mesaDiv.style.display = 'none';
        return;
    }
    
    // Mostrar mesa
    mesaDiv.style.display = 'block';
    
    let total = 0;
    mesaVentas.forEach((item, index) => {
        total += item.subtotal;
        
        const fila = document.createElement('tr');
        fila.innerHTML = `
            <td>
                <strong>${item.nombre}</strong><br>
                <small class="text-muted">Código: ${item.codigo}</small>
            </td>
            <td><span class="badge bg-secondary">${item.proveedor}</span></td>
            <td>$${item.precio.toFixed(2)}</td>
            <td>
                <div class="input-group input-group-sm" style="width: 120px;">
                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="cambiarCantidad(${index}, -1)">-</button>
                    <input type="number" class="form-control text-center" value="${item.cantidad}" min="1" ${!item.sinStock ? `max="${item.stockDisponible}"` : ''} 
                           onchange="setCantidad(${index}, this.value)" style="width: 60px;">
                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="cambiarCantidad(${index}, 1)">+</button>
                </div>
            </td>
            <td><strong>$${item.subtotal.toFixed(2)}</strong></td>
            <td>
                ${item.sinStock ? 
                    '<span class="badge bg-warning">⚠️ Sin Stock</span>' : 
                    `<span class="badge bg-info">${item.stockDisponible} disp.</span>`}
            </td>
            <td>
                <button type="button" class="btn btn-danger btn-sm" onclick="quitarDeMesa(${index})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        cuerpoMesa.appendChild(fila);
    });
    
    // Actualizar contador y total
    contadorMesa.textContent = mesaVentas.length;
    totalMesa.textContent = `$${total.toFixed(2)}`;
    btnVenderMesa.disabled = mesaVentas.length === 0;
}

function cambiarCantidad(index, cambio) {
    const item = mesaVentas[index];
    const nuevaCantidad = item.cantidad + cambio;
    
    if (nuevaCantidad >= 1 && (item.sinStock || nuevaCantidad <= item.stockDisponible)) {
        item.cantidad = nuevaCantidad;
        item.subtotal = item.cantidad * item.precio;
        actualizarMesa();
        guardarCarrito();
    } else if (!item.sinStock && nuevaCantidad > item.stockDisponible) {
        alert('No hay suficiente stock disponible');
    }
}

function setCantidad(index, nuevaCantidad) {
    const item = mesaVentas[index];
    const cantidad = parseInt(nuevaCantidad);
    
    if (cantidad >= 1 && (item.sinStock || cantidad <= item.stockDisponible)) {
        item.cantidad = cantidad;
        item.subtotal = item.cantidad * item.precio;
        actualizarMesa();
        guardarCarrito();
    } else if (!item.sinStock && cantidad > item.stockDisponible) {
        alert('No hay suficiente stock disponible');
        document.querySelector(`input[onchange="setCantidad(${index}, this.value)"]`).value = item.cantidad;
    }
}

function quitarDeMesa(index) {
    mesaVentas.splice(index, 1);
    actualizarMesa();
    guardarCarrito();
}

function limpiarMesa() {
    if (mesaVentas.length > 0 && confirm('¿Seguro que quiere limpiar toda la mesa de ventas?')) {
        mesaVentas = [];
        actualizarMesa();
        guardarCarrito();
    }
}

function ocultarMesa() {
    document.getElementById('mesaVentas').style.display = 'none';
}

function procesarVentaMesa() {
    if (mesaVentas.length === 0) {
        alert('No hay productos en la mesa de ventas');
        return;
    }
    
    // Verificar si hay productos sin stock
    const productosSinStock = mesaVentas.filter(item => item.sinStock);
    
    let confirmacion = `¿Confirmar venta de ${mesaVentas.length} productos por un total de ${document.getElementById('totalMesa').textContent}?`;
    
    if (productosSinStock.length > 0) {
        confirmacion = `⚠️ ATENCIÓN: ${productosSinStock.length} producto(s) en la mesa NO tienen stock físico (solo están en lista de precios).\n\n${confirmacion}`;
    }
    
    if (confirm(confirmacion)) {
        // Enviar datos al servidor
        fetch('{{ url_for("procesar_venta_mesa") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({
                productos: mesaVentas,
                csrf_token: '{{ csrf_token() }}'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Venta procesada exitosamente!\n\n' + data.message);
                mesaVentas = [];
                actualizarMesa();
                guardarCarrito(); // Limpiar carrito guardado tras venta exitosa
                // Enfocar el campo de código para continuar escaneando
                document.getElementById('codigo_barras').focus();
            } else {
                alert('Error al procesar la venta:\n\n' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al procesar la venta: ' + error.message);
        });
    }
}
</script>
{% endblock %}