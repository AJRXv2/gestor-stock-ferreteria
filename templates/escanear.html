{% extends 'base.html' %}

{% block title %}Escaneo de Productos{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2><i class="bi bi-upc-scan me-2"></i>Escaneo de Productos</h2>
    
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-barcode me-2"></i>Escanear C√≥digo de Barras</h5>
                </div>
                <div class="card-body">
                    <form id="escanerForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <!-- Selector de Proveedor para Filtro Inteligente -->
                        <div class="mb-3">
                            <label for="proveedor_escaner_main" class="form-label">Filtro de Proveedor (Opcional):</label>
                            <select id="proveedor_escaner_main" name="proveedor_filtro" class="form-select">
                                <option value="">üîç B√∫squeda Autom√°tica (Todos los proveedores)</option>
                                <optgroup label="Ricky">
                                    <option value="brementools">Bremen Tools</option>
                                    <option value="crossmaster">üéØ Crossmaster (UPC-A: 7824‚Üí9977824, 9977824.1)</option>
                                    <option value="berger">Berger</option>
                                    <option value="chiesa">Chiesa</option>
                                    <option value="cachan">Cachan</option>
                                </optgroup>
                                <optgroup label="Ferreter√≠a General">
                                    <option value="nortedist">Norte Distribuidora</option>
                                    <option value="bermon">Bermon</option>
                                    <option value="dewalt">DeWalt</option>
                                    <option value="sica">Sica</option>
                                    <option value="sorbalok">Sorbalok</option>
                                </optgroup>
                            </select>
                            <small class="text-muted">üí° Crossmaster: UPC-A 12 d√≠gitos (190349378240 ‚Üí extrae 7824 ‚Üí busca 9927824, 9927824.1, 9937824, 9937824.1...)</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="codigo_barras" class="form-label">C√≥digo de Barras:</label>
                            <input type="text" class="form-control form-control-lg" id="codigo_barras" name="codigo_barras" autofocus 
                                placeholder="Escanee un c√≥digo o ingrese manualmente...">
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-lg">
                            <span id="btnTexto">Buscar Producto</span>
                            <span id="btnSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        </button>
                        <button type="button" class="btn btn-secondary btn-lg ms-2" onclick="limpiarFormulario()">Limpiar</button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Instrucciones</h5>
                </div>
                <div class="card-body">
                    <ol>
                        <li>Aseg√∫rese de que el cursor est√© en el campo de c√≥digo.</li>
                        <li>Escanee el c√≥digo de barras del producto.</li>
                        <li>Los resultados aparecer√°n autom√°ticamente abajo.</li>
                        <li>Use los botones para vender directamente o agregar a la mesa.</li>
                    </ol>
                    <div class="alert alert-info">
                        <i class="bi bi-lightbulb me-2"></i>El esc√°ner se mantiene activo para escanear m√∫ltiples productos sin recargar la p√°gina.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Secci√≥n de Resultados Din√°micos -->
    <div class="row mt-4" id="seccionResultados" style="display:none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-search me-2"></i>Productos Encontrados</h5>
                </div>
                <div class="card-body">
                    <div id="productosEncontrados">
                        <!-- Contenido din√°mico de productos -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Mesa de Ventas (igual que en confirmar_escaneo.html) -->
    <div class="row mt-4" id="mesaVentas" style="display:none;">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-table me-2"></i>Mesa de Ventas 
                            <span class="badge bg-light text-dark" id="contadorMesa">0</span>
                        </h5>
                        <div>
                            <button type="button" class="btn btn-success me-2" id="btnVenderMesa" onclick="procesarVentaMesa()" disabled>
                                <i class="bi bi-cart-check"></i> Vender Todo
                            </button>
                            <button type="button" class="btn btn-warning me-2" onclick="limpiarMesa()">
                                <i class="bi bi-trash"></i> Limpiar
                            </button>
                            <button type="button" class="btn btn-outline-light" onclick="ocultarMesa()">
                                <i class="bi bi-eye-slash"></i> Ocultar
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Proveedor</th>
                                    <th>Precio Unit.</th>
                                    <th>Cantidad</th>
                                    <th>Subtotal</th>
                                    <th>Stock</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="cuerpoMesa">
                                <!-- Contenido din√°mico -->
                            </tbody>
                            <tfoot>
                                <tr class="table-primary">
                                    <td colspan="4"><strong>TOTAL:</strong></td>
                                    <td><strong id="totalMesa">$0.00</strong></td>
                                    <td colspan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let mesaVentas = [];
let contadorId = 0;

// Funci√≥n para formatear precios al estilo europeo
function formatearPrecioEuropeo(precio) {
    try {
        // Convertir a n√∫mero si es string
        if (typeof precio === 'string') {
            precio = parseFloat(precio.replace(',', '.'));
        } else if (precio == null) {
            precio = 0.0;
        }
        
        const precioFloat = parseFloat(precio);
        
        // L√ìGICA CORREGIDA: Si el precio es menor a 1000, multiplicar por 1000
        let precioAmericano;
        if (precioFloat < 1000) {
            // Multiplicar por 1000 para que tenga separador de miles
            // Ejemplo: 5.50 -> 5500 -> formato "5,500.00"
            const precioAjustado = precioFloat * 1000;
            precioAmericano = precioAjustado.toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }) + '.00';
        } else {
            // Para precios >= 1000, formatear normalmente con 2 decimales
            precioAmericano = precioFloat.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        // Convertir al formato europeo: intercambiar puntos y comas
        let precioEuropeo = '';
        for (let char of precioAmericano) {
            if (char === ',') {
                precioEuropeo += '.';
            } else if (char === '.') {
                precioEuropeo += ',';
            } else {
                precioEuropeo += char;
            }
        }
        
        return precioEuropeo;
        
    } catch (error) {
        return '0,00';
    }
}

// Funciones de persistencia del carrito
function guardarCarrito() {
    localStorage.setItem('mesaVentas', JSON.stringify(mesaVentas));
    localStorage.setItem('contadorId', contadorId.toString());
}

function cargarCarrito() {
    const carritoGuardado = localStorage.getItem('mesaVentas');
    const contadorGuardado = localStorage.getItem('contadorId');
    
    if (carritoGuardado) {
        mesaVentas = JSON.parse(carritoGuardado);
    }
    
    if (contadorGuardado) {
        contadorId = parseInt(contadorGuardado);
    }
    
    // Actualizar la tabla visual
    actualizarMesa();
}

document.addEventListener('DOMContentLoaded', function() {
    // Cargar carrito guardado al iniciar
    cargarCarrito();
    
    // Auto-enfoque en el campo de c√≥digo de barras
    document.getElementById('codigo_barras').focus();
    
    // Manejar env√≠o del formulario con AJAX
    document.getElementById('escanerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        procesarEscaneo();
    });
    
    // Manejar la entrada del esc√°ner
    const inputCodigo = document.getElementById('codigo_barras');
    
    // Muchos esc√°neres terminan con enter, as√≠ que podemos autoenviar el formulario
    inputCodigo.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            procesarEscaneo();
        }
    });
    
    // Para esc√°neres que no env√≠an enter, podemos detectar cuando se detiene la entrada r√°pida
    let typingTimer;
    const doneTypingInterval = 500; // Tiempo en ms despu√©s del cual consideramos que termin√≥ el escaneo
    
    inputCodigo.addEventListener('keyup', function() {
        clearTimeout(typingTimer);
        if (inputCodigo.value) {
            typingTimer = setTimeout(function() {
                // Si el c√≥digo tiene longitud suficiente para ser un c√≥digo de barras, asumimos que el escaneo termin√≥
                if (inputCodigo.value.length >= 8 && inputCodigo.value.length <= 20) {
                    procesarEscaneo();
                }
            }, doneTypingInterval);
        }
    });
});

function procesarEscaneo() {
    const codigoBarras = document.getElementById('codigo_barras').value.trim();
    const proveedorFiltro = document.getElementById('proveedor_escaner_main').value;
    
    if (!codigoBarras) {
        alert('Debe ingresar un c√≥digo de barras');
        return;
    }
    
    // Mostrar informaci√≥n del filtro en consola
    if (proveedorFiltro) {
        console.log(`üéØ ESC√ÅNER INTELIGENTE: Usando filtro espec√≠fico para '${proveedorFiltro}'`);
    } else {
        console.log('üîç ESC√ÅNER INTELIGENTE: Modo autom√°tico (todos los proveedores)');
    }
    
    // Mostrar spinner con informaci√≥n del proveedor
    const textoBoton = proveedorFiltro ? `Buscando en ${proveedorFiltro}...` : 'Buscando...';
    document.getElementById('btnTexto').textContent = textoBoton;
    document.getElementById('btnSpinner').classList.remove('d-none');
    
    // Enviar petici√≥n AJAX con filtro inteligente
    fetch('{{ url_for("procesar_escaneo") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: new URLSearchParams({
            'codigo_barras': codigoBarras,
            'proveedor_filtro': proveedorFiltro,
            'csrf_token': '{{ csrf_token() }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        // Ocultar spinner
        document.getElementById('btnTexto').textContent = 'Buscar Producto';
        document.getElementById('btnSpinner').classList.add('d-none');
        
        if (data.success) {
            mostrarProductos(data.productos);
            // Limpiar campo para pr√≥ximo escaneo
            document.getElementById('codigo_barras').value = '';
            document.getElementById('codigo_barras').focus();
        } else {
            mostrarError(data.message);
            // No limpiar campo en caso de error para permitir correcci√≥n
            document.getElementById('codigo_barras').select();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Ocultar spinner
        document.getElementById('btnTexto').textContent = 'Buscar Producto';
        document.getElementById('btnSpinner').classList.add('d-none');
        alert('Error al procesar el escaneo: ' + error.message);
        document.getElementById('codigo_barras').select();
    });
}

function mostrarProductos(productos) {
    const seccionResultados = document.getElementById('seccionResultados');
    const productosEncontrados = document.getElementById('productosEncontrados');
    
    let html = `<div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>C√≥digo</th>
                    <th>Producto</th>
                    <th>Proveedor</th>
                    <th>Stock</th>
                    <th>Precio</th>
                    <th>Due√±o</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>`;
    
    productos.forEach(producto => {
        html += `<tr>
            <td>
                <span class="badge bg-primary">${producto.codigo_extraido}</span>
                <br>
                <small class="text-muted">Original: ${producto.codigo}</small>
            </td>
            <td><strong>${producto.nombre}</strong></td>
            <td><span class="badge bg-secondary">${producto.proveedor || 'N/A'}</span></td>
            <td>`;
        
        if (producto.source === 'excel') {
            html += `<div>
                <span class="badge bg-info">Solo en Lista de Precios</span>
                <br>
                <small class="text-muted">No hay stock f√≠sico</small>
            </div>`;
        } else if (producto.cantidad <= 0) {
            html += `<span class="badge bg-danger">Sin stock</span>`;
        } else if (producto.cantidad <= 5) {
            html += `<span class="badge bg-warning">${producto.cantidad} unidades</span>`;
        } else {
            html += `<span class="badge bg-success">${producto.cantidad} unidades</span>`;
        }
        
        html += `</td>
            <td><strong>${producto.precio_formato_europeo || formatearPrecioEuropeo(producto.precio)}</strong></td>
            <td><span class="badge ${producto.dueno === 'ricky' ? 'bg-info' : 'bg-warning'}">${producto.dueno || 'N/A'}</span></td>
            <td>`;
        
        if (producto.source === 'excel') {
            // Producto solo en lista de precios - ASEGURAR QUE EL PRECIO ES NUM√âRICO
            const precioNumerico = parseFloat(producto.precio || 0);
            html += `<button type="button" class="btn btn-warning btn-sm" 
                data-producto-id="${producto.id}" 
                data-codigo="${producto.codigo}" 
                data-nombre="${producto.nombre}" 
                data-precio="${precioNumerico}" 
                data-proveedor="${producto.proveedor}" 
                data-stock="0" 
                data-sin-stock="true"
                onclick="agregarAMesaFromButton(this)"
                title="Este producto no est√° en stock, solo en lista de precios">
                <i class="bi bi-table"></i> A Mesa (Sin Stock)
            </button>`;
        } else if (producto.cantidad > 0) {
            html += `<div class="btn-group-vertical" role="group">
                <form method="post" action="{{ url_for('ejecutar_venta_escaneo') }}" class="mb-1" style="display:inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="producto_id" value="${producto.id}">
                    <div class="input-group input-group-sm">
                        <input type="number" class="form-control" name="cantidad" value="1" min="1" max="${producto.cantidad}" style="width: 60px;">
                        <button type="submit" class="btn btn-success btn-sm">
                            <i class="bi bi-cart-plus"></i> Vender
                        </button>
                    </div>
                </form>
                <button type="button" class="btn btn-primary btn-sm" 
                    data-producto-id="${producto.id}" 
                    data-codigo="${producto.codigo}" 
                    data-nombre="${producto.nombre}" 
                    data-precio="${parseFloat(producto.precio || 0)}" 
                    data-proveedor="${producto.proveedor}" 
                    data-stock="${producto.cantidad}" 
                    data-sin-stock="false"
                    onclick="agregarAMesaFromButton(this)">
                    <i class="bi bi-table"></i> A Mesa
                </button>
            </div>`;
        } else {
            html += `<span class="text-muted">Sin acciones disponibles</span>`;
        }
        
        html += `</td></tr>`;
    });
    
    html += `</tbody></table></div>`;
    
    productosEncontrados.innerHTML = html;
    seccionResultados.style.display = 'block';
    
    // Scroll suave hacia los resultados
    seccionResultados.scrollIntoView({ behavior: 'smooth' });
}

function mostrarError(mensaje) {
    const seccionResultados = document.getElementById('seccionResultados');
    const productosEncontrados = document.getElementById('productosEncontrados');
    
    productosEncontrados.innerHTML = `
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>No se encontraron productos</strong>
            <p class="mb-0">${mensaje}</p>
        </div>
    `;
    
    seccionResultados.style.display = 'block';
    seccionResultados.scrollIntoView({ behavior: 'smooth' });
}

function limpiarFormulario() {
    document.getElementById('codigo_barras').value = '';
    document.getElementById('seccionResultados').style.display = 'none';
    document.getElementById('codigo_barras').focus();
}

// Funciones de Mesa de Ventas (igual que en confirmar_escaneo.html)
function agregarAMesa(productoId, codigo, nombre, precio, proveedor, stockDisponible, sinStock = false) {
    // Nota: Eliminada la advertencia de stock f√≠sico por solicitud del usuario
    
    // CRUCIAL: Asegurar que el precio sea num√©rico
    const precioNumerico = parseFloat(precio || 0);
    console.log(`üî¢ Agregando a mesa - Precio original: ${precio}, Precio num√©rico: ${precioNumerico}`);
    
    // Verificar si el producto ya existe en la mesa
    const existeIndex = mesaVentas.findIndex(item => item.productoId === productoId);
    
    if (existeIndex >= 0) {
        // Si existe, aumentar cantidad
        if (!sinStock && mesaVentas[existeIndex].cantidad < stockDisponible) {
            mesaVentas[existeIndex].cantidad++;
            mesaVentas[existeIndex].subtotal = mesaVentas[existeIndex].cantidad * mesaVentas[existeIndex].precio;
        } else if (sinStock) {
            // Para productos sin stock, permitir incrementar cantidad pero con advertencia
            mesaVentas[existeIndex].cantidad++;
            mesaVentas[existeIndex].subtotal = mesaVentas[existeIndex].cantidad * mesaVentas[existeIndex].precio;
        } else {
            alert('No hay m√°s stock disponible para este producto');
            return;
        }
    } else {
        // Si no existe, agregar nuevo - USAR PRECIO NUM√âRICO
        const nuevoItem = {
            id: ++contadorId,
            productoId: productoId,
            codigo: codigo,
            nombre: nombre,
            precio: precioNumerico,  // ‚Üê PRECIO NUM√âRICO
            proveedor: proveedor,
            cantidad: 1,
            subtotal: precioNumerico,  // ‚Üê SUBTOTAL NUM√âRICO
            stockDisponible: stockDisponible,
            sinStock: sinStock,
            precio_formato_europeo: formatearPrecioEuropeo(precioNumerico)  // ‚Üê AGREGAR FORMATO EUROPEO
        };
        console.log(`‚ûï Nuevo item en mesa:`, nuevoItem);
        mesaVentas.push(nuevoItem);
    }
    
    actualizarMesa();
    guardarCarrito();
}

function agregarAMesaFromButton(button) {
    // Leer datos del bot√≥n usando data attributes
    const productoId = button.getAttribute('data-producto-id');
    const codigo = button.getAttribute('data-codigo');
    const nombre = button.getAttribute('data-nombre');
    const precio = parseFloat(button.getAttribute('data-precio'));
    const proveedor = button.getAttribute('data-proveedor');
    const stockDisponible = parseInt(button.getAttribute('data-stock'));
    const sinStock = button.getAttribute('data-sin-stock') === 'true';
    
    // Llamar a la funci√≥n original
    agregarAMesa(productoId, codigo, nombre, precio, proveedor, stockDisponible, sinStock);
}

function actualizarMesa() {
    const cuerpoMesa = document.getElementById('cuerpoMesa');
    const contadorMesa = document.getElementById('contadorMesa');
    const totalMesa = document.getElementById('totalMesa');
    const btnVenderMesa = document.getElementById('btnVenderMesa');
    const mesaDiv = document.getElementById('mesaVentas');
    
    // Limpiar tabla
    cuerpoMesa.innerHTML = '';
    
    if (mesaVentas.length === 0) {
        mesaDiv.style.display = 'none';
        return;
    }
    
    // Mostrar mesa
    mesaDiv.style.display = 'block';
    
    let total = 0;
    mesaVentas.forEach((item, index) => {
        total += item.subtotal;
        
        const fila = document.createElement('tr');
        fila.innerHTML = `
            <td>
                <strong>${item.nombre}</strong><br>
                <small class="text-muted">C√≥digo: ${item.codigo}</small>
            </td>
            <td><span class="badge bg-secondary">${item.proveedor}</span></td>
            <td><strong>${item.precio_formato_europeo || formatearPrecioEuropeo(item.precio)}</strong></td>
            <td>
                <div class="input-group input-group-sm" style="width: 120px;">
                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="cambiarCantidad(${index}, -1)">-</button>
                    <input type="number" class="form-control text-center" value="${item.cantidad}" min="1" ${!item.sinStock ? `max="${item.stockDisponible}"` : ''} 
                           onchange="setCantidad(${index}, this.value)" style="width: 60px;">
                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="cambiarCantidad(${index}, 1)">+</button>
                </div>
            </td>
                        </div>
            <td><strong>${formatearPrecioEuropeo(item.subtotal)}</strong></td>
            <td>
            <td>
                ${item.sinStock ? 
                    '<span class="badge bg-warning">‚ö†Ô∏è Sin Stock</span>' : 
                    `<span class="badge bg-info">${item.stockDisponible} disp.</span>`}
            </td>
            <td>
                <button type="button" class="btn btn-danger btn-sm" onclick="quitarDeMesa(${index})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        cuerpoMesa.appendChild(fila);
    });
    
    // Actualizar contador y total
    contadorMesa.textContent = mesaVentas.length;
    totalMesa.textContent = formatearPrecioEuropeo(total);
    btnVenderMesa.disabled = mesaVentas.length === 0;
}

function cambiarCantidad(index, cambio) {
    const item = mesaVentas[index];
    const nuevaCantidad = item.cantidad + cambio;
    
    if (nuevaCantidad >= 1 && (item.sinStock || nuevaCantidad <= item.stockDisponible)) {
        item.cantidad = nuevaCantidad;
        item.subtotal = item.cantidad * item.precio;
        actualizarMesa();
        guardarCarrito();
    } else if (!item.sinStock && nuevaCantidad > item.stockDisponible) {
        alert('No hay suficiente stock disponible');
    }
}

function setCantidad(index, nuevaCantidad) {
    const item = mesaVentas[index];
    const cantidad = parseInt(nuevaCantidad);
    
    if (cantidad >= 1 && (item.sinStock || cantidad <= item.stockDisponible)) {
        item.cantidad = cantidad;
        item.subtotal = item.cantidad * item.precio;
        actualizarMesa();
        guardarCarrito();
    } else if (!item.sinStock && cantidad > item.stockDisponible) {
        alert('No hay suficiente stock disponible');
        document.querySelector(`input[onchange="setCantidad(${index}, this.value)"]`).value = item.cantidad;
    }
}

function quitarDeMesa(index) {
    mesaVentas.splice(index, 1);
    actualizarMesa();
    guardarCarrito();
}

function limpiarMesa() {
    if (mesaVentas.length > 0 && confirm('¬øSeguro que quiere limpiar toda la mesa de ventas?')) {
        mesaVentas = [];
        actualizarMesa();
        guardarCarrito();
    }
}

function ocultarMesa() {
    document.getElementById('mesaVentas').style.display = 'none';
}

function procesarVentaMesa() {
    if (mesaVentas.length === 0) {
        alert('No hay productos en la mesa de ventas');
        return;
    }
    
    // Verificar si hay productos sin stock
    const productosSinStock = mesaVentas.filter(item => item.sinStock);
    
    let confirmacion = `¬øConfirmar venta de ${mesaVentas.length} productos por un total de ${document.getElementById('totalMesa').textContent}?`;
    
    if (productosSinStock.length > 0) {
        confirmacion = `‚ö†Ô∏è ATENCI√ìN: ${productosSinStock.length} producto(s) en la mesa NO tienen stock f√≠sico (solo est√°n en lista de precios).\n\n${confirmacion}`;
    }
    
    if (confirm(confirmacion)) {
        // Enviar datos al servidor
        fetch('{{ url_for("procesar_venta_mesa") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({
                productos: mesaVentas,
                csrf_token: '{{ csrf_token() }}'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Venta procesada exitosamente!\n\n' + data.message);
                mesaVentas = [];
                actualizarMesa();
                guardarCarrito(); // Limpiar carrito guardado tras venta exitosa
                // Enfocar el campo de c√≥digo para continuar escaneando
                document.getElementById('codigo_barras').focus();
            } else {
                alert('Error al procesar la venta:\n\n' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al procesar la venta: ' + error.message);
        });
    }
}
</script>
{% endblock %}