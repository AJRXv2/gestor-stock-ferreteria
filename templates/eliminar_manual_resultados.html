<!-- Template para mostrar resultados de búsqueda de productos manuales -->
{% if productos and productos|length > 0 %}
<div class="table-responsive">
    <table class="table table-sm table-striped">
        <thead>
            <tr>
                <th><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
                <th>Nombre</th>
                <th>Código</th>
                <th>Precio</th>
                <th>Proveedor</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for producto in productos %}
            <tr>
                <td><input type="checkbox" class="product-select" value="{{ producto.codigo or producto.Codigo or '' }}"></td>
                <td>{{ producto.nombre or producto.Nombre or 'Sin nombre' }}</td>
                <td>{{ producto.codigo or producto.Codigo or 'S/C' }}</td>
                <td>
                    {% set precio_val = producto.precio or producto.Precio %}
                    {% if precio_val and precio_val != 0 %}
                        ${{ "%.2f"|format(precio_val|float) }}
                    {% else %}
                        N/A
                    {% endif %}
                </td>
                <td>{{ producto.proveedor or producto.Proveedor or 'N/A' }}</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="eliminarProductoIndividual('{{ (producto.codigo or producto.Codigo or '')|e }}')">
                        <i class="bi bi-trash"></i> Eliminar
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="mt-3">
    <div class="btn-group">
        <button class="btn btn-warning" onclick="eliminarSeleccionados()">
            <i class="bi bi-trash"></i> Eliminar Seleccionados
        </button>
        <button class="btn btn-danger" onclick="eliminarTodosBusqueda()">
            <i class="bi bi-trash-fill"></i> Eliminar Todos los Resultados
        </button>
    </div>
    <small class="text-muted d-block mt-2">{{ productos|length }} producto(s) encontrado(s)</small>
</div>

<script>
function toggleSelectAll() {
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.product-select');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

function eliminarProductoIndividual(codigo) {
    if (!confirm('¿Está seguro de eliminar este producto?')) return;
    
    const searchTerm = document.querySelector('input[name="search_term"]').value || '';
    
    fetch('{{ url_for("eliminar_manual_ajax") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            codigo_a_eliminar: codigo,
            search_term: searchTerm,
            csrf_token: '{{ csrf_token() }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('resultados-container').innerHTML = data.html;
            showMessage(data.msg, 'success');
        } else {
            showMessage(data.msg, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error al eliminar el producto', 'error');
    });
}

function eliminarSeleccionados() {
    const selected = Array.from(document.querySelectorAll('.product-select:checked')).map(cb => cb.value);
    if (selected.length === 0) {
        alert('No hay productos seleccionados');
        return;
    }
    
    if (!confirm(`¿Está seguro de eliminar ${selected.length} producto(s) seleccionado(s)?`)) return;
    
    const searchTerm = document.querySelector('input[name="search_term"]').value || '';
    
    fetch('{{ url_for("eliminar_manual_seleccionados_ajax") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            codigos: selected,
            search_term: searchTerm,
            csrf_token: '{{ csrf_token() }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('resultados-container').innerHTML = data.html;
            showMessage(data.msg, 'success');
        } else {
            showMessage(data.msg, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error al eliminar los productos', 'error');
    });
}

function eliminarTodosBusqueda() {
    const count = {{ productos|length }};
    if (!confirm(`¿Está seguro de eliminar TODOS los ${count} producto(s) de esta búsqueda?`)) return;
    
    const searchTerm = document.querySelector('input[name="search_term"]').value || '';
    
    fetch('{{ url_for("eliminar_manual_todo_ajax") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            search_term: searchTerm,
            csrf_token: '{{ csrf_token() }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('resultados-container').innerHTML = data.html;
            showMessage(data.msg, 'success');
        } else {
            showMessage(data.msg, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error al eliminar los productos', 'error');
    });
}

function showMessage(message, type) {
    // Crear y mostrar mensaje de alerta
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const alertHtml = `<div class="alert ${alertClass} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
    
    const container = document.getElementById('messages-container') || document.body;
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = alertHtml;
    container.insertBefore(tempDiv.firstElementChild, container.firstChild);
}
</script>
{% else %}
<div class="alert alert-info">
    {% if search_term %}
        No se encontraron productos que coincidan con "{{ search_term }}".
    {% else %}
        No hay productos para mostrar.
    {% endif %}
</div>
{% endif %}