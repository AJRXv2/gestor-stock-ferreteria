{% extends "base.html" %}
{% block title %}Historial de Stock{% endblock %}
{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2">Historial de Stock</h1>
</div>

<div class="card mb-3">
  <div class="card-body row g-2 align-items-end">
    <div class="card mb-3 p-3">
      <h5>Importar CSV de Stock</h5>
      <form id="formImportCSV" class="row g-2 align-items-end" enctype="multipart/form-data" onsubmit="return false;">
        <div class="col-md-4">
          <label class="form-label">Archivo CSV</label>
          <input type="file" accept=".csv" class="form-control" id="csvFileInput" required />
        </div>
        <div class="col-md-2">
          <label class="form-label">Dry Run</label>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="chkDryRun" checked>
            <label class="form-check-label small" for="chkDryRun">Simular</label>
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Al existir fila</label>
          <select id="existingMode" class="form-select">
            <option value="update" selected>Actualizar</option>
            <option value="skip">Omitir</option>
          </select>
        </div>
        <div class="col-md-3 d-grid">
          <button id="btnImportarCSV" class="btn btn-primary" type="button">Importar CSV</button>
        </div>
        <div class="col-12 small text-muted">
          Formato esperado: FechaCompra,Codigo,Nombre,Proveedor,Precio,Cantidad,Observaciones,Dueno,CreatedAt
        </div>
      </form>
      <div id="importResult" class="mt-2"></div>
    </div>
    <div class="col-sm-3">
      <label class="form-label">Dueño</label>
      <select id="filtro-dueno" class="form-select">
        <option value="">Todos</option>
        <option value="ferreteria_general">Ferretería General</option>
        <option value="ricky">Ricky</option>
      </select>
    </div>
    <div class="col-sm-3">
      <label class="form-label">Proveedor</label>
      <select id="filtro-proveedor" class="form-select">
        <option value="">Todos</option>
        {% for prov in proveedores %}
          <option value="{{ prov }}">{{ prov }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-sm-4">
      <label class="form-label">Buscar (código, nombre, proveedor, observaciones)</label>
      <input type="text" id="filtro-termino" class="form-control" placeholder="Ej: tornillo 8mm...">
    </div>
    <div class="col-sm-2 d-grid">
      <button id="btn-buscar" class="btn btn-primary">Buscar</button>
    </div>
    <div class="col-12 d-flex gap-2 mt-2">
      <button id="btn-eliminar-seleccionados" class="btn btn-danger btn-sm">Eliminar seleccionados</button>
      <button id="btn-eliminar-todo" class="btn btn-outline-danger btn-sm">Eliminar todo (según filtros)</button>
      <span class="ms-auto text-muted small" id="resultado-count"></span>
    </div>
  </div>
</div>

<div id="contenedor-tabla" class="table-responsive">
  <div class="text-center text-muted py-5" id="placeholder-carga">Use los filtros y presione Buscar.</div>
</div>

<script>
const csrfToken = '{{ csrf_token() }}';
const contenedorTabla = document.getElementById('contenedor-tabla');
const countEl = document.getElementById('resultado-count');
function cargarHistorial(){
  const dueno = document.getElementById('filtro-dueno').value;
  const proveedor = document.getElementById('filtro-proveedor').value;
  const termino = document.getElementById('filtro-termino').value.trim();
  contenedorTabla.innerHTML = '<div class="text-center text-muted py-5">Cargando...</div>';
  fetch("{{ url_for('historial_datos') }}", {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
    body: JSON.stringify({ dueno, proveedor, termino, csrf_token: csrfToken })
  }).then(r=>r.json()).then(res=>{
    if(res.success){
      contenedorTabla.innerHTML = res.html;
      countEl.textContent = res.count + ' resultado(s)';
      inicializarAccionesFila();
    } else {
      contenedorTabla.innerHTML = '<div class="alert alert-danger">Error: '+ (res.error||'') +'</div>';
    }
  }).catch(()=>{
    contenedorTabla.innerHTML = '<div class="alert alert-danger">Error de red</div>';
  });
}
document.getElementById('btn-buscar').addEventListener('click', cargarHistorial);
document.getElementById('filtro-termino').addEventListener('keydown', e=>{ if(e.key==='Enter'){ cargarHistorial(); }});

// Al cambiar el dueño, refrescar lista de proveedores
document.getElementById('filtro-dueno').addEventListener('change', ()=>{
  const dueno = document.getElementById('filtro-dueno').value;
  const selProv = document.getElementById('filtro-proveedor');
  selProv.innerHTML = '<option value="">Cargando...</option>';
  fetch("{{ url_for('historial_proveedores') }}", {
    method:'POST',
    headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},
    body: JSON.stringify({ dueno, csrf_token: csrfToken })
  }).then(r=>r.json()).then(res=>{
    if(res.success){
      const opts = ['<option value="">Todos</option>'].concat(res.proveedores.map(p=>`<option value="${p}">${p}</option>`));
      selProv.innerHTML = opts.join('');
    } else {
      selProv.innerHTML = '<option value="">(error)</option>';
    }
  }).catch(()=>{ selProv.innerHTML = '<option value="">(error)</option>'; });
});

function obtenerSeleccionados(){
  return Array.from(document.querySelectorAll('.select-row-unified:checked')).map(cb=>cb.value);
}

document.getElementById('btn-eliminar-seleccionados').addEventListener('click', ()=>{
  const ids = obtenerSeleccionados();
  if(ids.length===0){ alert('No hay seleccionados.'); return; }
  if(!confirm('¿Eliminar '+ids.length+' elemento(s)?')) return;
  fetch("{{ url_for('eliminar_seleccionados') }}", {
    method:'POST',
    headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},
    body: JSON.stringify({ ids, csrf_token: csrfToken })
  }).then(r=>r.json()).then(res=>{
    if(res.success){ cargarHistorial(); } else { alert(res.error||'Error al eliminar'); }
  }).catch(()=>alert('Error de red'));
});

document.getElementById('btn-eliminar-todo').addEventListener('click', ()=>{
  if(!confirm('¿Eliminar TODO lo filtrado? Esta acción es irreversible.')) return;
  const dueno = document.getElementById('filtro-dueno').value;
  if(!dueno){ alert('Seleccione un dueño específico para eliminar todo.'); return; }
  fetch("{{ url_for('eliminar_todo_historial') }}", {
    method:'POST',
    headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},
    body: JSON.stringify({ csrf_token: csrfToken, dueno })
  }).then(r=>r.json()).then(res=>{
    if(res.success){ cargarHistorial(); } else { alert(res.error||'Error al eliminar todo'); }
  }).catch(()=>alert('Error de red'));
});

function inicializarAccionesFila(){
  document.querySelectorAll('.form-vender').forEach(form => {
    if(form.dataset.bound) return;
    form.dataset.bound = '1';
    form.addEventListener('submit', function(e){
      e.preventDefault();
      const qty = this.querySelector('input[name="cantidad_vendida"]').value || '1';
      fetch(this.action, {
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},
        body: JSON.stringify({ cantidad_vendida: parseInt(qty,10), csrf_token: csrfToken })
      }).then(r=>r.json()).then(res=>{
        if(res && res.success){
          const row = this.closest('tr');
          const cantidadCell = row?.querySelector('td:nth-child(7)');
          if(cantidadCell){ cantidadCell.textContent = res.nueva_cantidad; }
          const statusCell = row?.querySelector('td:nth-child(9)');
          if(statusCell){
            let html='';
            if(res.nueva_cantidad <= 0){ html='<i class="bi bi-x-circle text-danger" title="Sin stock"></i>'; }
            else if(parseInt(res.avisar_bajo_stock||0,10)===1 && res.min_stock_aviso!==null && res.nueva_cantidad <= parseInt(res.min_stock_aviso||0,10)){
              html = `<i class=\"bi bi-exclamation-triangle text-warning\" title=\"Stock bajo (${res.nueva_cantidad} / ${res.min_stock_aviso})\"></i>`;
            } else { html='<i class="bi bi-check-circle text-success" title="Stock suficiente"></i>'; }
            statusCell.innerHTML = html;
          }
        } else { alert((res && res.error)||'Error al vender'); }
      }).catch(()=>alert('Error de red'));
    });
  });
}
// --- Importar CSV ---
document.getElementById('btnImportarCSV')?.addEventListener('click', function(){
  const fileInput = document.getElementById('csvFileInput');
  if(!fileInput.files.length){
    alert('Seleccione un archivo CSV');
    return;
  }
  const fd = new FormData();
  fd.append('file', fileInput.files[0]);
  const dryRun = document.getElementById('chkDryRun').checked ? '1':'0';
  const existingMode = document.getElementById('existingMode').value;
  fd.append('dry_run', dryRun);
  fd.append('existing_mode', existingMode);
  const btn = this;
  btn.disabled = true; btn.textContent = 'Procesando...';
  fetch('/import_stock_csv', {method:'POST', body: fd, headers: { 'X-CSRFToken': csrfToken }})
    .then(async r=>{
      const ct = r.headers.get('Content-Type') || '';
      if(!r.ok){
        // Intentar extraer texto para diagnosticar
        const text = await r.text();
        throw new Error('HTTP '+r.status+' '+text.slice(0,200));
      }
      if(ct.includes('application/json')){
        return r.json();
      } else {
        const text = await r.text();
        throw new Error('Respuesta no JSON (posible login/HTML): '+text.slice(0,120));
      }
    })
    .then(data=>{
      btn.disabled = false; btn.textContent = 'Importar CSV';
      if(!data.success){
        document.getElementById('importResult').innerHTML = '<div class="alert alert-danger">Error: '+ (data.error||'') +'</div>';
      } else {
        const errs = (data.errores||[]).map(e=>'<li>'+e+'</li>').join('');
        document.getElementById('importResult').innerHTML = '<div class="alert alert-'+(data.dry_run?'warning':'success')+'">'+(data.dry_run?'Dry Run (simulación) ':'Importación completa ')+'Insertados: '+data.inserted+' Actualizados: '+data.updated+' Omitidos vacíos: '+data.skipped+' Omitidos existentes: '+data.skipped_existentes+' Errores: '+data.errores_total+(data.backup?(' Backup: '+data.backup):'')+'</div>' + (errs?'<ul class="small">'+errs+'</ul>':'');
        if(!data.dry_run){
          cargarHistorial();
        }
      }
    })
    .catch(err=>{
      btn.disabled = false; btn.textContent = 'Importar CSV';
      document.getElementById('importResult').innerHTML = '<div class="alert alert-danger">Error: '+err.message+'</div>';
    });
});
</script>
{% endblock %}
